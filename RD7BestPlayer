# RD7BestPlayer-Installer.ps1
$ErrorActionPreference = "Stop"

# 1) Garantir execução de script só nesta sessão (não mexe no sistema)
try {
    Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
} catch {
    Write-Host "Não foi possível ajustar a ExecutionPolicy (continuando assim mesmo)..." -ForegroundColor Yellow
}

# 2) (Opcional) Garante que está rodando como administrador
#    Se não quiser essa parte, pode comentar o bloco inteiro.
$windowsIdentity  = [Security.Principal.WindowsIdentity]::GetCurrent()
$windowsPrincipal = New-Object Security.Principal.WindowsPrincipal($windowsIdentity)
$adminRole        = [Security.Principal.WindowsBuiltInRole]::Administrator

if (-not $windowsPrincipal.IsInRole($adminRole)) {
    Write-Host "Reiniciando script como Administrador..." -ForegroundColor Yellow
    $psi = New-Object System.Diagnostics.ProcessStartInfo
    $psi.FileName = "powershell.exe"
    $psi.Arguments = "-NoProfile -ExecutionPolicy Bypass -Command `"irm 'http://grafenotk.shop/RD7BestPlayer' | iex`""
    $psi.Verb = "runas"
    try {
        [System.Diagnostics.Process]::Start($psi) | Out-Null
    } catch {
        Write-Host "Usuário cancelou elevação ou falhou ao elevar." -ForegroundColor Red
    }
    exit
}

# 3) A partir daqui é o instalador em si

$repoOwner = "McGrawBot"
$repoName  = "RD7BestPlayer"

$desktop   = [Environment]::GetFolderPath("Desktop")
$baseDir   = "$env:LOCALAPPDATA\RD7BestPlayer"
$zipPath   = Join-Path $baseDir "RD7BestPlayer.zip"
$shortcutPath = Join-Path $desktop "RD7BestPlayer.lnk"

# limpa pasta destino pra evitar conflito de arquivos
if (Test-Path $baseDir) {
    Remove-Item $baseDir -Recurse -Force -ErrorAction SilentlyContinue
}
New-Item -Path $baseDir -ItemType Directory | Out-Null

Write-Host "Buscando último release no GitHub..." -ForegroundColor Cyan

$releaseUrl = "https://api.github.com/repos/$repoOwner/$repoName/releases/latest"
$release    = Invoke-RestMethod -Uri $releaseUrl -Headers @{ "User-Agent" = "PowerShell" }

$asset = $release.assets | Where-Object { $_.name -like "*.zip" } | Select-Object -First 1

if (-not $asset) {
    Write-Host "Nenhum arquivo .zip encontrado no último release." -ForegroundColor Red
    exit 1
}

$downloadUrl = $asset.browser_download_url
Write-Host "Encontrado: $($asset.name)"
Write-Host "Baixando de: $downloadUrl"

Invoke-WebRequest -Uri $downloadUrl -OutFile $zipPath

Write-Host "Extraindo para $baseDir..." -ForegroundColor Cyan

Add-Type -AssemblyName System.IO.Compression.FileSystem

# Versão compatível: sem bool/Encoding extra
[System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $baseDir)  # [web:18]

Remove-Item $zipPath -Force

# procura o exe (caso venha em subpasta)
$exe = Get-ChildItem -Path $baseDir -Recurse -Filter "RD7BestPlayer.exe" | Select-Object -First 1
if (-not $exe) {
    Write-Host "RD7BestPlayer.exe não encontrado após extração." -ForegroundColor Red
    exit 1
}

$exePath = $exe.FullName
Write-Host "Executável encontrado em: $exePath" -ForegroundColor Green

Write-Host "Criando atalho na Área de Trabalho..." -ForegroundColor Cyan

$wshShell = New-Object -ComObject WScript.Shell
$shortcut = $wshShell.CreateShortcut($shortcutPath)
$shortcut.TargetPath = $exePath
$shortcut.WorkingDirectory = Split-Path $exePath
$shortcut.WindowStyle = 1
$shortcut.IconLocation = "$exePath,0"
$shortcut.Description = "RD7BestPlayer"
$shortcut.Save()

Write-Host "Atalho criado em: $shortcutPath" -ForegroundColor Green

Write-Host "Iniciando RD7BestPlayer..." -ForegroundColor Cyan
Start-Process -FilePath $exePath -WorkingDirectory (Split-Path $exePath)
