# RD7BestPlayer-Installer.ps1
$ErrorActionPreference = "Stop"

$repoOwner = "McGrawBot"
$repoName  = "RD7BestPlayer"

$desktop   = [Environment]::GetFolderPath("Desktop")
$baseDir   = "$env:LOCALAPPDATA\RD7BestPlayer"
$zipPath   = Join-Path $baseDir "RD7BestPlayer.zip"
$shortcutPath = Join-Path $desktop "RD7BestPlayer.lnk"

if (-not (Test-Path $baseDir)) {
    New-Item -Path $baseDir -ItemType Directory | Out-Null
}

Write-Host "Buscando último release no GitHub..." -ForegroundColor Cyan

$releaseUrl = "https://api.github.com/repos/$repoOwner/$repoName/releases/latest"
$release    = Invoke-RestMethod -Uri $releaseUrl -Headers @{ "User-Agent" = "PowerShell" }

$asset = $release.assets | Where-Object { $_.name -like "*.zip" } | Select-Object -First 1

if (-not $asset) {
    Write-Host "Nenhum arquivo .zip encontrado no último release." -ForegroundColor Red
    exit 1
}

$downloadUrl = $asset.browser_download_url
Write-Host "Encontrado: $($asset.name)"
Write-Host "Baixando de: $downloadUrl"

Invoke-WebRequest -Uri $downloadUrl -OutFile $zipPath

Write-Host "Extraindo para $baseDir..." -ForegroundColor Cyan

Add-Type -AssemblyName System.IO.Compression.FileSystem

# limpa tudo menos o zip
Get-ChildItem $baseDir -Recurse -Force |
    Where-Object { $_.FullName -ne $zipPath } |
    Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

# SOBRECARGA CORRETA: (zip, destino, overwriteFiles)
[System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $baseDir, $true)  # [web:18]

Remove-Item $zipPath -Force

# procura o exe
$exe = Get-ChildItem -Path $baseDir -Recurse -Filter "RD7BestPlayer.exe" | Select-Object -First 1
if (-not $exe) {
    Write-Host "RD7BestPlayer.exe não encontrado após extração." -ForegroundColor Red
    exit 1
}

$exePath = $exe.FullName
Write-Host "Executável encontrado em: $exePath" -ForegroundColor Green

Write-Host "Criando atalho na Área de Trabalho..." -ForegroundColor Cyan

$wshShell = New-Object -ComObject WScript.Shell
$shortcut = $wshShell.CreateShortcut($shortcutPath)
$shortcut.TargetPath = $exePath
$shortcut.WorkingDirectory = Split-Path $exePath
$shortcut.WindowStyle = 1
$shortcut.IconLocation = "$exePath,0"
$shortcut.Description = "RD7BestPlayer"
$shortcut.Save()

Write-Host "Atalho criado em: $shortcutPath" -ForegroundColor Green

Write-Host "Iniciando RD7BestPlayer..." -ForegroundColor Cyan
Start-Process -FilePath $exePath -WorkingDirectory (Split-Path $exePath)
